# Настройка подтверждения email при регистрации

## Что было добавлено

1. **Проверка email при регистрации** - теперь при регистрации пользователь должен подтвердить свой email адрес
2. **Отправка письма с подтверждением** - автоматическая отправка письма на указанный email
3. **Блокировка входа без подтверждения** - пользователь не может войти, пока не подтвердит email
4. **Повторная отправка письма** - возможность запросить новое письмо подтверждения

## Шаг 1: Запуск миграции

Необходимо добавить поля в таблицу `users` для хранения статуса подтверждения email:

```bash
cd backend
npm run migrate-email-verification
```

Или через bat файл (если создан):
```bash
cd backend
migrate-email-verification.bat
```

## Шаг 2: Настройка SMTP (если еще не настроено)

Убедитесь, что в `backend/.env` настроены параметры SMTP:

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=ваш_email@gmail.com
SMTP_PASSWORD=ваш_пароль_приложения_gmail
SMTP_FROM=ваш_email@gmail.com
FRONTEND_URL=http://localhost:3000
```

Подробнее см. `backend/ADD-SMTP-TO-ENV.md`

## Шаг 3: Перезапуск сервера

После миграции перезапустите backend сервер:

```bash
cd backend
npm run dev
```

## Как это работает

### Регистрация

1. Пользователь заполняет форму регистрации
2. Система создает аккаунт с `email_verified = false`
3. Генерируется токен подтверждения
4. Отправляется письмо на указанный email со ссылкой подтверждения
5. Пользователь видит сообщение о необходимости подтвердить email

### Подтверждение email

1. Пользователь переходит по ссылке из письма
2. Backend проверяет токен и подтверждает email
3. Пользователь автоматически входит в систему (получает JWT токен)
4. Перенаправление на главную страницу

### Вход

1. При попытке входа система проверяет, подтвержден ли email
2. Если email не подтвержден - показывается ошибка с кнопкой для повторной отправки письма
3. Если email подтвержден - вход выполняется как обычно

### Повторная отправка письма

1. На странице входа, если email не подтвержден, есть кнопка "Отправить письмо подтверждения повторно"
2. Или можно использовать endpoint `/api/auth/resend-verification` с параметром `email`

## API Endpoints

### POST /api/auth/register
Регистрация нового пользователя. Теперь возвращает сообщение вместо токена.

**Ответ:**
```json
{
  "message": "Регистрация успешна! Пожалуйста, проверьте вашу почту и подтвердите email адрес.",
  "user": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com"
  }
}
```

### GET /api/auth/verify-email?token=...
Подтверждение email по токену. Делает редирект на frontend с JWT токеном.

### POST /api/auth/resend-verification
Повторная отправка письма подтверждения.

**Тело запроса:**
```json
{
  "email": "user@example.com"
}
```

## Важные замечания

1. **Существующие пользователи** - пользователи, зарегистрированные до добавления этой функции, имеют `email_verified = false` по умолчанию. Им нужно будет подтвердить email при следующем входе.

2. **Для тестирования** - можно временно установить `email_verified = true` для существующих пользователей через SQL:
   ```sql
   UPDATE users SET email_verified = TRUE WHERE email = 'ваш_email@example.com';
   ```

3. **Токены подтверждения** - токены хранятся в поле `email_verification_token` и удаляются после подтверждения.

4. **Срок действия токена** - в текущей реализации токены не имеют срока действия, но можно добавить поле `email_verification_expires_at` для ограничения времени действия.

## Устранение проблем

### Письма не приходят
- Проверьте настройки SMTP в `.env`
- Проверьте логи backend сервера
- Убедитесь, что `FRONTEND_URL` правильно настроен

### Ошибка при подтверждении
- Проверьте, что токен не был использован ранее
- Убедитесь, что миграция выполнена успешно
- Проверьте логи backend сервера

### Пользователь не может войти после подтверждения
- Проверьте, что токен сохранился в localStorage
- Убедитесь, что frontend правильно обрабатывает редирект с токеном
- Проверьте консоль браузера на наличие ошибок
