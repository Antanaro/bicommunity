# Парсинг Telegram каналов

## Описание

Бот поддерживает парсинг публичных Telegram каналов через команду `/parse`. Это позволяет массово импортировать посты из каналов на форум.

## Настройка

### 1. Получение API credentials

1. Перейдите на https://my.telegram.org
2. Войдите с вашим номером телефона
3. Перейдите в раздел **"API development tools"**
4. Если приложения нет — создайте новое (любое название)
5. Скопируйте:
   - **App api_id** (число)
   - **App api_hash** (строка из 32 символов)

### 2. Получение Session String

Запустите скрипт авторизации:

```bash
cd backend
npm run telegram-auth
```

Скрипт запросит:
- API ID
- API Hash
- Номер телефона (в формате +7...)
- Код из Telegram (придет в приложение)

После успешной авторизации скрипт выведет `TELEGRAM_SESSION_STRING`.

### 3. Настройка .env

Добавьте в `.env` файл:

```env
TELEGRAM_API_ID=ваш_api_id
TELEGRAM_API_HASH=ваш_api_hash
TELEGRAM_SESSION_STRING=ваша_session_string
```

### 4. Перезапуск сервера

После добавления переменных перезапустите сервер:

```bash
npm run build
npm start
```

## Использование

### Команды бота

**`/parse @channel_name [количество]`**
- Парсит посты из публичного канала
- `@channel_name` — username канала (без @)
- `количество` — сколько постов спарсить (по умолчанию 50, макс. 500)

**Примеры:**
```
/parse durov 10        # Последние 10 постов из @durov
/parse telegram        # Последние 50 постов из @telegram
/parse channel_name 100 # Последние 100 постов
```

**`/stop`**
- Останавливает текущий парсинг

**`/status`**
- Показывает статус:
  - Bot API (работает ли бот)
  - MTProto Client (подключен ли для парсинга)
  - Парсинг (активен ли сейчас)

**`/help`**
- Показывает справку по всем командам

### Процесс парсинга

1. Бот получает сообщения из канала
2. Для каждого сообщения:
   - Извлекается текст
   - Скачиваются изображения (если есть)
   - Создается тема на форуме в категории "Telegram"
   - Добавляется ссылка на оригинальное сообщение
3. Отправляется прогресс каждые 10 сообщений
4. В конце выводится итоговая статистика

## Ограничения

- ⚠️ Парсинг работает только для **публичных** каналов
- ⚠️ Приватные каналы недоступны
- ⚠️ Максимум 500 постов за один запрос
- ⚠️ Парсинг может занять время для больших каналов

## Устранение неполадок

### Ошибка "MTProto клиент не настроен"

Проверьте что в `.env` есть все три переменные:
- `TELEGRAM_API_ID`
- `TELEGRAM_API_HASH`
- `TELEGRAM_SESSION_STRING`

### Ошибка "Канал не найден"

- Убедитесь что канал публичный
- Проверьте правильность username (без @)
- Убедитесь что канал существует

### Ошибка "API_ID_INVALID"

- Проверьте что API ID и API Hash скопированы правильно
- Убедитесь что нет лишних пробелов в `.env`
- Получите новые credentials на https://my.telegram.org

### Код не приходит при авторизации

- Проверьте приложение Telegram на телефоне
- Подождите 1-2 минуты
- Попробуйте еще раз через несколько минут

## Безопасность

⚠️ **ВАЖНО:**
- `TELEGRAM_SESSION_STRING` содержит вашу авторизацию
- Храните его в безопасности
- Не публикуйте в открытом доступе
- Не коммитьте в git (должен быть в `.gitignore`)

## Технические детали

- Используется библиотека `telegram` (gramjs) для MTProto API
- Парсинг работает асинхронно, не блокируя другие функции бота
- Изображения сохраняются в `backend/uploads/`
- Темы создаются от имени системного пользователя `telegram_bot`
