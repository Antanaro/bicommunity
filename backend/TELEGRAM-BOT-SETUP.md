# Настройка Telegram-бота

Этот документ описывает, как настроить Telegram-бота для автоматического создания тем на форуме из форвардированных сообщений.

## Функциональность

Telegram-бот позволяет:
- Пересылать сообщения из Telegram-каналов или от пользователей боту
- Автоматически создавать темы на форуме в категории "Telegram"
- Сохранять информацию об исходном канале и ссылку на сообщение

## Шаг 1: Создание бота в Telegram

1. Откройте Telegram и найдите бота [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям:
   - Укажите имя бота (например, "Forum Bot")
   - Укажите username бота (должен заканчиваться на `bot`, например, `my_forum_bot`)
4. BotFather предоставит вам токен бота (например, `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

## Шаг 2: Настройка переменных окружения

Добавьте токен бота в файл `.env` в директории `backend`:

```env
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
```

**Важно:** Замените `your_telegram_bot_token_here` на реальный токен, полученный от BotFather.

## Шаг 3: Установка зависимостей

Убедитесь, что установлены все зависимости:

```bash
cd backend
npm install
```

Библиотека `node-telegram-bot-api` уже добавлена в `package.json`.

## Шаг 4: Запуск сервера

Запустите сервер:

```bash
npm run dev
```

или

```bash
npm start
```

При успешной инициализации вы увидите в консоли:
```
✅ Telegram bot initialized: @your_bot_username
✅ Telegram category found (ID: X)
✅ Telegram bot user found (ID: Y)
```

## Использование

1. Найдите вашего бота в Telegram по username
2. Начните диалог с ботом (отправьте `/start`)
3. Перешлите любое сообщение из канала или от пользователя боту
4. Бот автоматически создаст тему на форуме в категории "Telegram"

## Что происходит при пересылке сообщения

1. Бот получает форвардированное сообщение
2. Извлекает информацию:
   - Текст сообщения
   - Название канала/пользователя
   - ID сообщения
   - Дата сообщения
3. Создает тему на форуме с:
   - Заголовком: "Из [Название канала]"
   - Содержимым: текст сообщения + метаданные (источник, ссылка, дата)
4. Отправляет подтверждение пользователю в Telegram

## Автоматическое создание ресурсов

При первом запуске бот автоматически:
- Создает категорию "Telegram" (если её нет)
- Создает системного пользователя `telegram_bot` (если его нет)

## Формат создаваемых тем

Тема создается со следующим содержимым:

```
[Текст исходного сообщения]

---
**Источник:** [Название канала]
**Ссылка на сообщение:** [Открыть в Telegram](https://t.me/...)
**Дата сообщения:** [Дата и время]
```

## Обработка медиа

Если сообщение содержит медиа (фото, видео, документы и т.д.):
- Фото → `[Фото]`
- Видео → `[Видео]`
- Документ → `[Документ: имя_файла]`
- Аудио → `[Аудио: название]`
- Стикер → `[Стикер]`

## Устранение неполадок

### Бот не отвечает

1. Проверьте, что токен указан правильно в `.env`
2. Убедитесь, что сервер запущен
3. Проверьте логи сервера на наличие ошибок

### Тема не создается

1. Проверьте подключение к базе данных
2. Убедитесь, что категория "Telegram" существует
3. Проверьте логи сервера для деталей ошибки

### Бот не видит форвардированные сообщения

- Убедитесь, что вы пересылаете сообщение (forward), а не копируете текст
- Некоторые каналы могут ограничивать пересылку сообщений

## Безопасность

- **Никогда не публикуйте токен бота** в публичных репозиториях
- Добавьте `.env` в `.gitignore`
- Используйте разные токены для development и production

## Остановка бота

Бот автоматически останавливается при остановке сервера. Для программной остановки:

```typescript
import { telegramBotService } from './services/telegram-bot';
await telegramBotService.stop();
```
